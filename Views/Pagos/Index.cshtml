@model IEnumerable<Inmobiliaria10.Models.Pago>
@{
    ViewData["Title"] = "Pagos";
    int? contratoSel  = ViewBag.Contrato as int?;
}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Pagos</h2>
  <a href="/Pagos/Auditoria" class="btn btn-dark">
    <i class="bi bi-clock-history"></i> Auditoría
  </a>
</div>

<form method="get" class="row g-2 mb-3 align-items-end" id="frmFiltros">
  <div class="col-12 col-md-6 d-flex align-items-center">
    <label for="fContrato" class="me-2 fw-bold">Contrato</label>
    <select id="fContrato" name="contrato" 
            class="form-select form-select-lg flex-grow-1"
            style="max-width: 400px, height:100px;">
    </select>
  </div>

  <div class="col-6 col-md-2">
    <button class="btn btn-dark w-80" type="submit" style="height:32px;">
      <i class="bi bi-funnel"></i> Buscar
    </button>
  </div>

  <div class="col-6 col-md-4 text-md-end">
    <a id="btnNuevo" class="btn btn-success" href="/Pagos/Crear" style="height:38px;">
      <i class="bi bi-plus-lg"></i> Nuevo pago
    </a>
  </div>
</form>



<table id="tblPagos" class="table table-striped align-middle w-100">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Detalle</th>
      <th>Concepto</th>
      <th class="text-end">Importe</th>
      <th>Contrato</th>
      <th>Estado</th>
      <th class="text-end" style="width:260px;">Acciones</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

@section Scripts {
  <!-- quitá estos includes si ya están en tu _Layout -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>

  <script>
  $(function () {
    // --- Select2: Contratos (texto: Contrato + Inmueble) ---
    $('#fContrato').select2({
      placeholder: 'Buscar contrato…',
      allowClear: true,
      ajax: {
        url: '/Pagos/search-contratos',
        dataType: 'json',
        delay: 250,
        data: p => ({ term: p.term || '', page: p.page || 1 }),
        processResults: d => ({ results: (d.results || []).map(x => ({ id: x.id, text: x.text })) })
      }
    });

    // --- Preselección desde ViewBag (si vino por query/redirect) ---
    const preContrato = @((contratoSel ?? 0));
    function preload(selector, fetchUrl, id) {
      if (!id || id <= 0) return;
      $.getJSON(fetchUrl, { id: id }, function (res) {
        if (res && res.item) {
          const opt = new Option(res.item.text, res.item.id, true, true);
          $(selector).append(opt).trigger('change');
        }
      });
    }
    preload('#fContrato', '/Pagos/search-contratos', preContrato);

    // --- DataTables (server-side) ---
    const dt = $('#tblPagos').DataTable({
      processing: true,
      serverSide: true,
      searching: false,
      lengthMenu: [10, 20, 50, 100],
      pageLength: 20,
      order: [[0, 'desc']], // Fecha desc (columna 0)
      ajax: {
        url: '/Pagos/data',
        data: d => {
          d.contrato = $('#fContrato').val() || '';
        }
      },
      columns: [
        { data: 'fechaPago' },                // string dd/MM/yyyy (o como lo devuelvas)
        { data: 'detalle' },
        { data: 'conceptoDenominacion' },     // Denominación
        {
          data: 'importe',
          className: 'text-end',
          render: v => {
            try { return v != null ? new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(v) : '-'; }
            catch { return v; }
          }
        },
        { data: 'contratoTexto' },            // Texto legible (no idContrato)
        {
          data: 'estado',
          render: v => v === 'Eliminado'
            ? '<span class="badge bg-warning text-dark">Eliminado</span>'
            : '<span class="badge bg-success">Activo</span>'
        },
        {
          data: 'idPago',
          orderable: false,
          className: 'text-end text-nowrap',
          render: (id) => {
            if (!id) return '';
            return `
              <a href="/Pagos/Detalles/${id}"  class="btn btn-sm btn-secondary"><i class="fa-solid fa-eye"></i></a>
              <a href="/Pagos/Editar/${id}"    class="btn btn-sm btn-primary"><i class="fa-solid fa-pen"></i></a>
              <a href="/Pagos/Eliminar/${id}"  class="btn btn-sm btn-danger"><i class="fa-solid fa-trash-can"></i></a>`;
          }
        }
      ],
      language: { url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/es-ES.json' }
    });

    // --- Recarga de tabla + actualizar botón "Nuevo" ---
    function updateNuevoHref() {
      const c = $('#fContrato').val();
      const url = c ? `/Pagos/Crear?contrato=${encodeURIComponent(c)}` : '/Pagos/Crear';
      $('#btnNuevo').attr('href', url);
    }
    $('#frmFiltros').on('submit', function (e) { e.preventDefault(); updateNuevoHref(); dt.ajax.reload(); });
    $('#fContrato').on('change', function () { updateNuevoHref(); dt.ajax.reload(); });

    // set inicial
    updateNuevoHref();
  });
  </script>
}
