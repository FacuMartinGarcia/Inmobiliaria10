@model Inmobiliaria10.Models.Pago
@{
    ViewData["Title"] = "Nuevo pago";
}

<div class="d-flex justify-content-center py-4">
  <div class="form-card">
    <div class="form-title">Nuevo pago</div>

    <form asp-action="Crear" method="post" class="needs-validation" novalidate>
        @Html.AntiForgeryToken()
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <partial name="_Form" />

        <div class="d-flex gap-2 mt-3">
            <a class="btn btn-secondary" asp-action="Index"><i class="bi bi-arrow-left"></i> Volver</a>
            <button type="submit" class="btn btn-success"><i class="bi bi-check-lg"></i> Guardar</button>
        </div>
    </form>
  </div>
</div>

@section Scripts{
    <!-- quitá estos includes si ya están en tu _Layout -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>

    <script>
    (function () {
      // Reemplaza el input de IdContrato por un select con Select2
      const $orig = $('#IdContrato');                 // generado por asp-for
      if ($orig.length) {
        // Copiar atributos de validación
        const $sel = $('<select class="form-select" style="width:100%"></select>');
        $.each($orig[0].attributes, function (_, a) {
          if (a && a.name && a.name.startsWith('data-val')) $sel.attr(a.name, a.value);
        });

        // Insertar y renombrar el original
        $orig.after($sel);
        $orig.attr('id', 'IdContrato_original').attr('name','').hide();
        $sel.attr('id','IdContrato').attr('name','IdContrato');

        // Inicializar Select2
        $('#IdContrato').select2({
          placeholder: 'Buscar contrato (Contrato + Inmueble)…',
          allowClear: true,
          ajax: {
            url: '/Pagos/search-contratos',
            dataType: 'json',
            delay: 250,
            data: p => ({ term: p.term || '', page: p.page || 1 }),
            processResults: d => ({ results: (d.results || []).map(x => ({ id: x.id, text: x.text })) })
          }
        });

        // Preselección si el modelo trae valor (por query ?contrato= o por default del controller)
        const pre = @Model.IdContrato;
        if (pre && pre > 0) {
          $.getJSON('/Pagos/search-contratos', { id: pre }, function (res) {
            if (res && res.item) {
              const opt = new Option(res.item.text, res.item.id, true, true);
              $('#IdContrato').append(opt).trigger('change');
            }
          });
        }
      }
    })();
    </script>
}
