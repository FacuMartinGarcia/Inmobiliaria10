@model Inmobiliaria10.Models.Pago
@{
    ViewData["Title"] = "Editar pago";
}

<h2 class="mb-3">Editar pago</h2>

<form asp-action="Editar" asp-route-id="@Model.IdPago" method="post" class="needs-validation" novalidate>
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <input type="hidden" asp-for="IdPago" />
    <partial name="_Form" />

    <div class="d-flex gap-2 mt-3">
        <a class="btn btn-secondary" asp-action="Detalles" asp-route-id="@Model.IdPago"><i class="bi bi-eye"></i> Ver</a>
        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Guardar cambios</button>
    </div>
</form>

@section Scripts{
    <!-- quitá estos includes si ya están en tu _Layout -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>

    <script>
    (function () {
      const $orig = $('#IdContrato');
      if ($orig.length) {
        const $sel = $('<select class="form-select" style="width:100%"></select>');
        $.each($orig[0].attributes, function (_, a) {
          if (a && a.name && a.name.startsWith('data-val')) $sel.attr(a.name, a.value);
        });

        $orig.after($sel);
        $orig.attr('id','IdContrato_original').attr('name','').hide();
        $sel.attr('id','IdContrato').attr('name','IdContrato');

        $('#IdContrato').select2({
          placeholder: 'Buscar contrato (Contrato + Inmueble)…',
          allowClear: true,
          ajax: {
            url: '/Pagos/search-contratos',
            dataType: 'json',
            delay: 250,
            data: p => ({ term: p.term || '', page: p.page || 1 }),
            processResults: d => ({ results: (d.results || []).map(x => ({ id: x.id, text: x.text })) })
          }
        });

        // Preselección con el valor actual del modelo
        const pre = @Model.IdContrato;
        if (pre && pre > 0) {
          $.getJSON('/Pagos/search-contratos', { id: pre }, function (res) {
            if (res && res.item) {
              const opt = new Option(res.item.text, res.item.id, true, true);
              $('#IdContrato').append(opt).trigger('change');
            }
          });
        }
      }
    })();
    </script>
}
