@model Inmobiliaria10.Models.Contrato

@{
    ViewData["Title"] = "Editar Contrato";
}

<style>
    .form-card { max-width: 1000px; width: 100%; }
    .rescision-section {
        border: 1px solid #ced4da;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        background-color: #a5a6a8;
    }
    .rescision-section h5 { margin-bottom: 15px; }
</style>

<div class="mt-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card form-card mx-auto">
                <div class="card-header form-card-header">
                    <h4 class="form-title">@ViewData["Title"]</h4>
                </div>
                <div class="card-body">
                    <form asp-controller="Contrato" asp-action="Editar" asp-route-id="@Model.IdContrato" method="post">
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.IdContrato)

                        <div asp-validation-summary="ModelOnly" class="alert alert-warning alert-dismissible fade show" role="alert">
                            <strong>Atención:</strong>
                            <ul></ul>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                        </div>

                        <!-- Inquilino e Inmueble -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="IdInquilino" class="form-label w-100 text-center">Inquilino</label>
                                <select id="inquilino" asp-for="IdInquilino" class="form-select" asp-items="ViewBag.Inquilinos">
                                    <option value="">-- Seleccione Inquilino --</option>
                                </select>
                                <span asp-validation-for="IdInquilino" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="IdInmueble" class="form-label w-100 text-center">Inmueble</label>
                                <select id="inmueble" asp-for="IdInmueble" class="form-select">
                                    <option value="">-- Seleccione Inmueble --</option>
                                    @foreach (var i in ViewBag.InmueblesRaw)
                                    {
                                        <option value="@i.IdInmueble"
                                                data-precio="@i.Precio?.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                                selected="@(Model.IdInmueble == i.IdInmueble)">
                                            @i.Direccion
                                            @(string.IsNullOrWhiteSpace(i.Piso) ? "" : $" Piso {i.Piso}")
                                            @(string.IsNullOrWhiteSpace(i.Depto) ? "" : $" Dpto {i.Depto}")
                                            @(string.IsNullOrWhiteSpace(i.DenominacionTipo) ? "" : $" - {i.DenominacionTipo}")
                                            - $@i.Precio
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="IdInmueble" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Fechas y Monto -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label asp-for="FechaInicio" class="form-label w-100 text-center">Fecha Inicio</label>
                                <input asp-for="FechaInicio" type="date" class="form-control text-center" />
                                <span asp-validation-for="FechaInicio" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="FechaFin" class="form-label w-100 text-center">Fecha Fin</label>
                                <input asp-for="FechaFin" type="date" class="form-control text-center" />
                                <span asp-validation-for="FechaFin" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="MontoMensual" class="form-label w-100 text-center">Monto Mensual</label>
                                <input asp-for="MontoMensual" type="number" step="0.01" min="0" class="form-control text-center" />
                                <span asp-validation-for="MontoMensual" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Rescisión -->
                        <div class="rescision-section">
                            <h6 class="form-subtitle text-center">Rescindir Contrato con Cálculo de Multa</h6>
                            <div class="d-flex justify-content-center align-items-end flex-wrap gap-3">
                                <div class="d-flex flex-column" style="flex: 0 0 200px;">
                                    <label asp-for="Rescision" class="form-label text-center">Fecha de Rescisión</label>
                                    <input asp-for="Rescision" type="date" class="form-control" id="Rescision" />
                                    <span asp-validation-for="Rescision" class="text-danger"></span>
                                </div>
                                <div class="d-flex flex-column" style="flex: 0 0 200px;">
                                    <label asp-for="MontoMulta" class="form-label text-center">Monto de Multa</label>
                                    <input asp-for="MontoMulta" type="number" step="0.01" min="0" class="form-control" id="MontoMulta" />
                                    <span asp-validation-for="MontoMulta" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Index" class="btn btn-back">
                                <i class="fa-solid fa-arrow-left me-2"></i> Cancelar
                            </a>
                            <button type="submit" id="btnGuardar" class="btn btn-save">
                                <i class="fa-solid fa-floppy-disk me-2"></i> Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate-unobtrusive/3.2.13/jquery.validate.unobtrusive.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/@@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(function () {

            $('#inquilino').select2({ 
                theme: 'bootstrap4', 
                placeholder: '-- Seleccione Inquilino --', 
                allowClear: true, 
                width: '100%' }).val('@Model.IdInquilino').trigger('change');
            $('#inmueble').select2({ 
                theme: 'bootstrap4', 
                placeholder: '-- Seleccione Inmueble --', 
                allowClear: true, 
                width: '100%' }).val('@Model.IdInmueble').trigger('change');

            $('#inmueble').on('change', function () {
                var precio = $(this).find(':selected').data('precio');
                $('#MontoMensual').val(precio);
            });

            async function calcularMulta() {
                const idContrato = @Model.IdContrato;
                const fechaRescision = $("#Rescision").val();
                const inputMontoMulta = $("#MontoMulta")[0];
                const spanValidacion = inputMontoMulta.nextElementSibling;

                inputMontoMulta.value = '';
                spanValidacion.textContent = '';

                if (!fechaRescision) return;

                const params = new URLSearchParams();
                params.append("idContrato", idContrato);
                params.append("fechaRescision", fechaRescision);

                try {
                    const resp = await fetch('@Url.Action("CalcularMulta")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params.toString()
                    });

                    const data = await resp.json();
                    if (data.ok && data.multa != null) {
                        inputMontoMulta.value = data.multa.toFixed(2);
                    } else {
                        spanValidacion.textContent = data.mensaje ?? "No se pudo calcular la multa.";
                    }
                } catch (ex) {
                    spanValidacion.textContent = "Error al comunicarse con el servidor.";
                }
            }
            $("#Rescision").on("change", calcularMulta);

            $('form').on('submit', function (e) {
                e.preventDefault();

                const fechaRescision = $("#Rescision").val();
                let mensaje = "Se actualizarán los datos del contrato.";
                let mostrarAlerta = false;

                if (fechaRescision) {
                    mensaje = "El contrato se va a rescindir. ¿Está seguro?";
                    mostrarAlerta = true;
                }

                if (mostrarAlerta) {
                    Swal.fire({
                        title: 'Confirmación',
                        text: mensaje,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, guardar',
                        cancelButtonText: 'Cancelar',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed && $(this).valid()) {
                            this.submit();
                        }
                    });
                } else {
                    if ($(this).valid()) {
                        this.submit();
                    }
                }
            });
        });
    </script>
}
